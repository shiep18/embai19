#include <Servo.h>
#include <Microduino_AudioPro.h>
#include <SD.h>

Servo servo_6;
uint8_t fileNum = 0;
AudioPro_FilePlayer musicPlayer =  AudioPro_FilePlayer(SD);

long item;
char code_input[4] = {};
char code_original[4] = {'1','2','3','1'};
char dakai[8] = {'o','p','e','n','d','o','o','r'};
char jiaoyan[10] {'b','e','g','i','n','c','h','e','c','k'};
int i = 0;
int flag_equal = 0;

void input_code();
void check_mode();
void serial_read_to_control();
void playNum(uint8_t);

void setup()
{
  Serial.begin(9600);
  servo_6.attach(6);
  pinMode(10,OUTPUT);
  pinMode(SD_PIN_SEL, OUTPUT);
  digitalWrite(SD_PIN_SEL, HIGH);
  delay(500);
  if (! musicPlayer.begin()) {
	while (1);
  }
  if (!SD.begin(SD_PIN_SEL)) {
        return;
  }
 musicPlayer.setVolume(125);
}

void loop()
{
  input_code();
  serial_read_to_control();
  delay(500);
  digitalWrite(10,LOW);
}

void playNum(uint8_t num) {
  if (num > musicPlayer.getMusicNum() - 1) {
    return;
  }
  if (!musicPlayer.paused() || !musicPlayer.stopped()) {
    musicPlayer.stopPlaying();
  }
  String _name = musicPlayer.getMusicName(num);
  Serial.print(F("Playing:"));
  if (!musicPlayer.playMP3(_name)) {
	Serial.println(F("ERROR"));
     }
  else {
		Serial.print(F("OK 	 File: "));
		Serial.println(_name);
	}
}
void input_code()
{
  if (!digitalRead(0)) {
    code_input[i] = '1';
    i++;
    digitalWrite(10,HIGH);
  }
  if (!digitalRead(2)) {
    code_input[i] = '2';
    i++;
    digitalWrite(10,HIGH);
  }
  if (!digitalRead(4)) {
    code_input[i] = '3';
    i++;
    digitalWrite(10,HIGH);
  }
  if (i >3) {
    Serial.write(code_input,4);
    i = 0;
    check_mode();
    code_input[4] = {};
    delay(4000);
  }
}
void check_mode()
{  
  for(int ii=0;ii<=3;ii++){
    if(code_input[ii] == code_original[ii]) flag_equal = 1;
    else {flag_equal = 0;break;}
  }
  if(flag_equal == 1) {playNum(1);Serial.write(jiaoyan,8);servo_6.write(180);flag_equal = 0;}
  else playNum(2);
}
void serial_read_to_control()

{

  if (Serial.available() > 0) {
    item = Serial.read();

  }
  if (item == '0') {
    Serial.println("hello 0");
    servo_2.write(180);
    delay(0);

  }
  if (item == '1') {
    Serial.println("hello 1");
    servo_2.write(90);
    delay(0);

  }
}