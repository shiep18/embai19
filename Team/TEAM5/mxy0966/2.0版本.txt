#include <Servo.h>
#include <U8glib.h>
Servo servo_2;
long item;
char code_input[4] = {};
char code_original[4] = {'1','2','3','1'};
char dakai[8] = {'o','p','e','n','d','o','o','r'};
int i = 0;
U8GLIB_SSD1306_128X64 u8g(U8G_I2C_OPT_NONE);
#define setFont_L u8g.setFont(u8g_font_unifont)
#define setFont_S u8g.setFont(u8g_font_fixed_v0r)
#define setFont_M u8g.setFont(u8g_font_9x15)
int flag_equal = 0;
void input_code();
void check_mode();
void serial_read_to_control();
void setup()
{
  Serial.begin(9600);
  servo_2.attach(2);
  pinMode(12,OUTPUT);
  digitalWrite(12,LOW);
  delay(500);
}
void loop()
{
  serial_read_to_control();
  input_code();
  delay(500);
  digitalWrite(12,LOW);
  u8g.undoRotation();
  u8g.firstPage();
  do {
    setFont_M;
    u8g.setPrintPos(0, 20);
    u8g.print("Enter password!");
  } while( u8g.nextPage() );
}
void input_code()
{
  if (!digitalRead(4)) {
    code_input[i] = '1';
    i++;
    digitalWrite(12,HIGH); 
    delay(50);
  }
  if (!digitalRead(5)) {
    code_input[i] = '2';
    i++;
    digitalWrite(12,HIGH);
    delay(50);
  }
  if (!digitalRead(6)) {
    code_input[i] = '3';
    i++;
    digitalWrite(12,HIGH);
    delay(50);
  }
  if (!digitalRead(7)) {
    code_input[i] = '4';
    i++;
    digitalWrite(12,HIGH);
    delay(50);
  }
  if (!digitalRead(8)) {
    code_input[i] = '5';
    i++;
    digitalWrite(12,HIGH);
    delay(50);
  }
  if (!digitalRead(9)) {
    code_input[i] = '6';
    i++;
    digitalWrite(12,HIGH);
    delay(50);
  }
  if (!digitalRead(10)) {
    code_input[i] = '7';
    i++;
    digitalWrite(12,HIGH);
    delay(50);
  }
  if (!digitalRead(11)) {
    code_input[i] = '8';
    i++;
    digitalWrite(12,HIGH);
    delay(50);
  }
  if (!digitalRead(13)) {
    //code_input[i] = '9';
    //i++;
    digitalWrite(12,HIGH);
    servo_2.write(90);
    delay(50);
  u8g.undoRotation();
  u8g.firstPage();
  do {
    setFont_M;
    u8g.setPrintPos(0, 20);
    u8g.print("Closing~~~");
  } while( u8g.nextPage() );
  }
  if (i > 3) {
    Serial.write(code_input,4);
    i = 0;
    check_mode();
    code_input[4] = {};
    delay(4000);
  u8g.undoRotation();
  u8g.firstPage();
  do {
    setFont_M;
    u8g.setPrintPos(0, 20);
    u8g.print("Enter password!");
  } while( u8g.nextPage() );
  }
}
void check_mode()
{  
  for(int ii=0;ii<=3;ii++){
    if(code_input[ii] == code_original[ii]) flag_equal = 1;
    else {flag_equal = 0;break;}
  }
  if(flag_equal == 1) {
  u8g.undoRotation();
  u8g.firstPage();
 do {
    setFont_M;
    u8g.setPrintPos(0, 20);
    u8g.print("Correct ^_^ !");
  } while( u8g.nextPage() );
   Serial.write(dakai,8);
   servo_2.write(180);
   flag_equal = 0;}
else {
  u8g.undoRotation();
  u8g.firstPage();
  do {
    setFont_M;
    u8g.setPrintPos(0, 20);
    u8g.print("Wrong *_* !");
  } while( u8g.nextPage() );
}
}
void serial_read_to_control()
{
  if (Serial.available() > 0) {
    item = Serial.read();}
    if(item == '1') {servo_2.write(180);
  Serial.println("hello 1");
  delay(0);
  u8g.undoRotation();
  u8g.firstPage();
  do {
    setFont_S;
    u8g.setPrintPos(0, 20);
    u8g.print("Opened by serial!");
  } while( u8g.nextPage() );
}
    if(item == '0') {servo_2.write(90);
  Serial.println("hello 0");
  delay(0);
  u8g.undoRotation();
  u8g.firstPage();
 do {
    setFont_S;
    u8g.setPrintPos(0, 20);
    u8g.print("Closed by serial!");
  } while( u8g.nextPage() );
}
    delay(500);
    item = 0;
}
// 串口+密码+按键关门+显示屏